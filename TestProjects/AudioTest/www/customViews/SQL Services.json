{"Category":"Development","Access":["SuperAdmin"],"Controller":"[\"$scope\", \"$http\", \"$timeout\", \"$q\", function SqlServicesScope($scope, $http, $timeout, $q) {\r\n\t$scope.SqlService = null;\r\n\t$scope.showScript = 0;\r\n\t$scope.ref={cat:null}\r\n\t$scope.OldCat=function(c){\r\n\t    $scope.SqlService.Category=c.cat || null;\r\n\t    $timeout(function(){\r\n\t        c.cat=null;\r\n\t    });\r\n\t}\r\n\t\r\n\t$scope.$on(\"$destroy\", function(){\r\n\t    if(SetHashParam){\r\n\t        SetHashParam(\"sCategory\");\r\n\t        SetHashParam(\"sService\");\r\n\t    }\r\n\t})\r\n\r\n\t/*let QueryParamsRegex = /@([_a-zA-Z][_a-zA-Z0-9]*)/g\r\n\t\r\n\tif(!$scope.QueryParams){\r\n    \t$scope.QueryParams = function (s) {\r\n    \t\tif (!s.Params) { s.Params = Array.from(new Set(Array.from(MatchAll(QueryParamsRegex, s.Query)).map(c => c[1]))).filter(c => c.indexOf('_') && c != \"CurrentUserId\"); s.runParams = {} };\r\n    \t\treturn s.Params;\r\n    \t}\r\n\t}*/\r\n\r\n\t$scope.onUpload = function(){\r\n\t    let fl = $(\"<input type='file' multiple>\")\r\n\t    fl.change(function(e){\r\n\t        ProcessUploads(Array.from(e.target.files));\r\n\t        $scope.$applyAsync();\r\n\t    })\r\n\t    fl[0].click();\r\n\t}\r\n\t\r\n\t$scope.UploadAll = function(){\r\n\t    $q.all($scope.Uploads.map(u =>{\r\n\t        return $http.post(\"/api/query/SaveSqlService\", { Service: u });\r\n\t    })).then(function(){\r\n\t        $scope.Uploads=null;\r\n\t    });\r\n\t}\r\n\t\r\n\t$scope.remove = function(list, index){\r\n\t    list.splice(index,1);\r\n\t}\r\n\t\r\n\t$scope.ClearUploads = function(){\r\n\t    $scope.Uploads=null;\r\n\t}\r\n\t\r\n\tfunction ProcessUploads(files){\r\n        $q.all(files.map(c => c.text())).then(function(f){\r\n            $scope.Uploads = f.map((txt, i) => {\r\n                if(files[i].name.slice(-5)==\".json\"){\r\n                    try{\r\n                        return JSON.parse(txt);\r\n                    } catch(e){}\r\n                }\r\n                return null;\r\n            }).filter(c => c);\r\n        });\t    \r\n\t}\r\n\t$scope.ToggleItem = function(list, item){\r\n\t    let idx = list.indexOf(item);\r\n\t    if(idx==-1) list.push(item);\r\n\t    else list.splice(idx, 1);\r\n\t}\r\n\t\r\n\t$scope.onDragOver = function(e){e.preventDefault();};\r\n\t$scope.onDragLeave = function(e){e.preventDefault();};\r\n\t$scope.onDragDrop = function(e){\r\n\t    e.preventDefault();\r\n\t    ProcessUploads(Array.from(e.originalEvent.dataTransfer.files));\r\n\t}\r\n\t\r\n\t\r\n\t$scope.Download = function(n,e){\r\n\t    e.preventDefault();\r\n\t    Download(\"\\ufeff\" + JSON.stringify(n,null,\"\\t\"), 'application/json', n.Name + \".json\");\r\n\t}\r\n\t\r\n\t$scope.GetSqlServices = function () {\r\n\t\treturn $http.post(\"/api/query/GetSqlServices\").then(r => {\r\n\t\t\t$scope.SqlServices = r.data;\r\n\t\t\tlet cats = {};\r\n\t\t\tr.data.forEach(c => { \r\n\t\t\t    c.Roles = c.Roles || []; \r\n\t\t\t    c.Params = null;\r\n\t\t\t    if(c.Category) cats[c.Category] = true;\r\n\t\t\t});\r\n\t\t\t$scope.Categories = Object.keys(cats).orderBy(c => c);\r\n\t\t});\r\n\t}\r\n\t$scope.GetSqlServices().then(function(){\r\n\t    if(GetHashParams){\r\n\t        let p = GetHashParams();\r\n\t        if(p.sCategory)$scope.SelectCategory(p.sCategory);\r\n\t        if(p.sService)$scope.GetSqlService($scope.SqlServices.find(c => c.Name==p.sService));\r\n\t    }\r\n\t});\r\n\t$scope.SelectCategory = function(c){\r\n\t    $scope.Category = c||null;\r\n\t    //if(SetHashParam)SetHashParam(\"sCategory\", $scope.Category);\r\n\t}\r\n\t$scope.GetServices = function(){\r\n\t    return $scope.SqlServices.filter(c => c.Category==$scope.Category);\r\n\t}\r\n\t$scope.GetSqlService = function (s) {\r\n\t\t$scope.SqlService = s;\r\n\t    //if(SetHashParam)SetHashParam(\"sService\", s.Name);\r\n\t}\r\n\tlet findingParams = null;\r\n\t$scope.FindParams = function () {\r\n\t\tif (findingParams) clearTimeout(findingParams);\r\n\t\tfindingParams = setTimeout(function () {\r\n\t\t    let oldParams = $scope.SqlService.runParams;\r\n\t\t\t$scope.SqlService.Params = null;\r\n\t\t\t$scope.QueryParams($scope.SqlService);\r\n\t\t\tif($scope.SqlService.Params) $scope.SqlService.Params.forEach(c => {\r\n\t\t\t    if(oldParams[c]) $scope.SqlService.runParams[c] = oldParams[c]; \r\n\t\t\t});\r\n\t\t\tfindingParams = null;\r\n\t\t\t$scope.$applyAsync();\r\n\t\t}, 2000);\r\n\t}\r\n\t$scope.SaveSqlService = function () {\r\n\t\tlet send = angular.copy($scope.SqlService);\r\n\t\tdelete send.runParams;\r\n\t\tif (!send.Roles.length) send.Roles = null;\r\n\t\tlet p = $http.post(\"/api/query/SaveSqlService\", { Service: send });\r\n\t\treturn p.then(function(){\r\n\t\t    return $scope.GetSqlServices();\r\n\t\t});\r\n\t}\r\n\t$scope.RunSqlService = function (Name, Params = {}) {\r\n\t\tp = {};\r\n\t\tObject.keys(Params).forEach(c => {\r\n\t\t\tlet tmp = Params[c].trim();\r\n\t\t\tp[c] = +tmp || (((tmp[0] == '\"' || tmp[0] == \"'\") && tmp[tmp.length - 1] == tmp[0]) ? tmp.slice(1, -1) : tmp);\r\n\t\t});\r\n\t\t$http.post(\"/api/Services/\" + Name, Params).then(function (r) {\r\n\t\t\t$scope.md_jsonEditor(r.data);\r\n\t\t\tconsole.log(r.data);\r\n\t\t}, function (r) {\r\n\t\t\tconsole.log(r);\r\n\t\t});\r\n\t}\r\n\t$scope.NewSqlService = function () {\r\n\t\t$scope.SqlService = { Roles: [\"SuperAdmin\"] };\r\n\t}\r\n\t$scope.SqlServiceBack = function () {\r\n\t\t$scope.SqlService = null;\r\n\t    if(SetHashParam)SetHashParam(\"sService\");\r\n\t}\r\n}]","IsModal":false,"Descr":null,"Html":"<style>\r\n    td{\r\n        padding:3px;\r\n    }\r\n</style>\r\n<md-card ng-if=\"Uploads&&Uploads.length\" style=\"display: inline-flex;\">\r\n    <md-card-content>\r\n        <table>\r\n            <tr>\r\n                <th>Filename</th>\r\n                <th>Category</th>\r\n                <th>Query</th>\r\n                <th>Single</th>\r\n                <th>Roles</th>\r\n                <th></th>\r\n            </tr>\r\n            <tr ng-repeat=\"u in Uploads\">\r\n                <td>{{u.Name}}.json</td>\r\n                <td>{{u.Category}}</td>\r\n                <td>{{!!u.Query?'&check;':''}}</td>\r\n                <td>{{!!u.Single?'&check;':''}}</td>\r\n                <td><span ng-repeat=\"r in u.Roles\">{{r}}{{ $last?'':', '}}</span></td>\r\n                <td>\r\n                    <md-button ng-click=\"remove(Uploads, $index)\" class=\"md-icon-button md-raised md-warn\"><i class=\"mdi mdi-close\"></i></md-button>\r\n                </td>\r\n            </tr>\r\n        </table>\r\n    </md-card-content>\r\n    <md-card-actions>\r\n        <md-button class=\"md-raised md-primary\" ng-click=\"UploadAll()\">Upload</md-button>\r\n        <md-button class=\"md-raised md-warn\" ng-click=\"ClearUploads()\">Clear</md-button>\r\n    </md-card-actions>\r\n</md-card>\r\n\r\n<md-card>\r\n    <md-card-content em-dragover=\"onDragOver($event)\" em-dragleave=\"onDragLeave($event)\" em-drop=\"onDragDrop($event)\">\r\n     \t<div>\r\n            <md-button class=\"md-raised\" ng-if=\"!SqlService\" ng-click=\"NewSqlService()\">New</md-button>\r\n    \t\t<md-button class=\"md-raised\" ng-if=\"!SqlService\" ng-click=\"onUpload()\">Upload</md-button>\r\n\t        <md-button class=\"md-raised md-warn\" ng-if=\"SqlService\" ng-click=\"SqlServiceBack()\">Back</md-button>\r\n    \t\t<md-button class=\"md-raised md-primary\" ng-if=\"SqlService\" ng-click=\"$root.DefaultMessage(SaveSqlService())\">Save</md-button>\r\n    \t</div>\r\n    \t<div ng-if=\"SqlServices&&!SqlService\" layout=\"row\">\r\n    \t    <div style=\"padding:10px\">\r\n        \t    <table>\r\n        \t        <tr><th>Categories</th></tr>\r\n        \t        <tr style=\"{{!Category?'color:white;background-color:blue':''}}\">\r\n                        <td style=\"white-space:pre;padding:5px 10px;cursor:pointer\" ng-click=\"SelectCategory()\">(none)</td>\r\n                    </tr>\r\n        \t\t\t<tr style=\"{{Category==c?'color:white;background-color:blue':''}}\" ng-repeat=\"c in Categories\">\r\n        \t\t\t\t<td style=\"white-space:pre;padding:5px 10px;cursor:pointer\" ng-click=\"SelectCategory(c)\">{{c}}</td>\r\n        \t\t\t</tr>\r\n        \t\t</table>\r\n    \t\t</div>\r\n    \t\t<div style=\"padding:10px\">\r\n    \t\t    <h4>Services</h4>\r\n    \t\t    <div style=\"overflow-y:auto;height:60vh\">\r\n            \t\t<table style=\"width:100%\">\r\n            \t\t\t<tr ng-repeat=\"t in GetServices()\" style=\"border-bottom:1px solid black\">\r\n            \t\t\t\t<td>\r\n            \t\t\t\t    <md-button style=\"text-transform:initial\" ng-click=\"GetSqlService(t)\">{{t.Name}}</md-button>\r\n            \t\t\t\t</td>\r\n            \t\t\t\t<td>\r\n            \t\t\t\t    <md-button ng-click=\"Download(t,$event)\">Download</md-button>\r\n            \t\t\t\t</td>\r\n            \t\t\t\t<td style=\"vertical-align: middle;\">{{Domain}}/api/Services/{{t.Name}}</td>\r\n            \t\t\t\t<td style=\"min-width: 220px;\">\r\n            \t\t\t\t    <div>\r\n            \t\t\t\t        <input ng-repeat=\"p in QueryParams(t)\" style=\"border-style:none;outline:none;border-bottom:1px solid gray;margin-right:3px;width:100px\" type=\"text\" name=\"qparam_{{p}}\" placeholder=\"{{p}}\" ng-model=\"t.runParams[p]\" />\r\n                \t\t\t\t    <!--md-input-container ng-repeat=\"p in QueryParams(t)\" style=\"display:inline-block;margin:auto\">\r\n                \t\t\t\t        <input type=\"text\" name=\"{{p}}\" placeholder=\"{{p}}\" ng-model=\"t.runParams[p]\" />\r\n                \t\t\t\t    </md-input-container-->\r\n            \t\t\t\t    </div>\r\n            \t\t\t\t</td>\r\n            \t\t\t\t<td>\r\n            \t\t\t\t    <md-button ng-click=\"RunSqlService(t.Name, t.runParams)\">Run</md-button>\r\n            \t\t\t\t</td>\r\n            \t\t\t</tr>\r\n            \t\t</table>\r\n    \t\t    </div>\r\n    \t\t</div>\r\n    \t</div>\r\n    \t<div ng-if=\"SqlService\" style=\"height:calc(100vh - 135px)\">\r\n    \t\t<table style=\"width:100%\">\r\n    \t\t\t<tr><td style=\"width:10px\">Name</td><td><input ng-model=\"SqlService.Name\" /></td></tr>\r\n    \t\t\t<tr>\r\n    \t\t\t    <td style=\"width:10px\">Category</td>\r\n    \t\t\t    <td>\r\n    \t\t\t        <div layout=\"row\">\r\n        \t\t\t        <md-input-container style=\"margin:0\">\r\n        \t\t\t            <input ng-model=\"SqlService.Category\" aria-label=\"Category\" />\r\n        \t\t\t        </md-input-container>\r\n        \t\t\t        <md-input-container style=\"margin:0\">\r\n            \t\t\t        <md-select ng-model=\"ref.cat\" ng-change=\"OldCat(ref)\" aria-label=\"Change Category\">\r\n            \t\t\t            <md-option ng-value=\"null\"></md-option>\r\n            \t\t\t            <md-option value=\"\">(clear)</md-option>\r\n            \t\t\t            <md-option ng-repeat=\"c in Categories\" value=\"{{c}}\">{{c}}</md-option>\r\n            \t\t\t        </md-select>\r\n        \t\t\t        </md-input-container>\r\n    \t\t\t        </div>\r\n    \t\t\t    </td>\r\n    \t\t\t</tr>\r\n    \t\t\t<tr>\r\n    \t\t\t\t<td style=\"vertical-align:top;\">Query</td>\r\n    \t\t\t\t<td>\r\n    \t\t\t\t\t<div class=\"editor\" ui-ace=\"{ mode: 'sql', theme: 'monokai' }\" ng-model=\"SqlService.Query\" ng-change=\"FindParams()\"></div>\r\n    \t\t\t\t</td>\r\n    \t\t\t</tr>\r\n    \t\t\t<tr>\r\n    \t\t\t\t<td>Run</td>\r\n    \t\t\t\t<td><button ng-click=\"RunSqlService(SqlService.Name, SqlService.runParams)\">{{SqlService.Name}}</button>  (<span ng-repeat=\"p in SqlService.Params\">{{$index?',':''}}<input type=\"text\" placeholder=\"{{p}}\" ng-model=\"SqlService.runParams[p]\" /></span>)</td>\r\n    \t\t\t</tr>\r\n    \t\t\t<tr>\r\n    \t\t\t\t<td>Single</td>\r\n    \t\t\t\t<td><input type=\"checkbox\" ng-model=\"SqlService.Single\" /></td>\r\n    \t\t\t</tr>\r\n    \t\t\t<tr>\r\n    \t\t\t\t<td>\r\n    \t\t\t\t\tRoles\r\n    \t\t\t\t</td>\r\n    \t\t\t\t<td>\r\n    \t\t\t\t\t<span ng-repeat=\"r in Roles\" style=\"cursor:pointer;margin:0 5px;{{SqlService.Roles.indexOf(r)!=-1?'color:blue':'color:grey'}}\" ng-click=\"ToggleItem(SqlService.Roles, r)\">{{r}}</span>\r\n    \t\t\t\t</td>\r\n    \t\t\t</tr>\r\n    \t\t</table>\r\n    \t</div>       \r\n    </md-card-content>\r\n</md-card>","Name":"SQL Services"}