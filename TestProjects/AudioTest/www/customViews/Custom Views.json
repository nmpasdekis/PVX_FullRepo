{"Category":"Development","Access":["SuperAdmin"],"Controller":"[\"$scope\", \"$http\", \"modaldbgFactory\", \"modal2Factory_dbg\", \"$q\", function ($scope, $http, modal, modal2, $q) {\r\n\t$scope.showScript = false;\r\n\t$scope.Category = null;\r\n\t$scope.ref = {};\r\n\t$scope.GetCustomViews = function () {\r\n\t\treturn $http.post(\"/api/view/GetCustomViewList\").then(function (r) {\r\n\t\t\t$scope.CustomViews = Object.keys(r.data);\r\n\t\t\t$scope.CustomViewsObj = r.data;\r\n\t\t\tlet cats = {};\r\n\t\t\t$scope.CustomViews.forEach(c => {\r\n\t\t\t    if(r.data[c]) cats[r.data[c]] = true;\r\n\t\t\t});\r\n\t\t\t$scope.Categories = Object.keys(cats);\r\n\t\t});\r\n\t};\r\n\t$scope.Parents = JSON.parse(localStorage.customViewParents||\"{}\");\r\n\t$scope.saveParent = function(n,p){\r\n\t    $scope.Parents[n]=p;\r\n\t    let tmp = JSON.parse(localStorage.customViewParents||\"{}\");\r\n\t    tmp[n]=p;\r\n\t    localStorage.customViewParents = JSON.stringify(tmp);\r\n\t}\r\n\t$scope.ViewSelectTab = function(t){\r\n\t    $scope.vTab = t;\r\n\t    //if(SetHashParam)SetHashParam(\"vTab\", t);\r\n\t}\r\n\tfunction OnResize(){\r\n\t    $scope.cvCols = Array.from(document.querySelectorAll(\".em-resizer th div\")).map(c => getComputedStyle(c).width);\r\n\t}\r\n\t\r\n\tlet w = $scope.$watch(function(){ \r\n\t    let elem = document.querySelector(\".em-resizer\") \r\n\t    if(elem) return elem.innerHTML;\r\n\t    return null;\r\n\t},function(n){\r\n\t    if(n) OnResize();\r\n\t})\r\n\t$scope.$on(\"$destroy\", function(){ \r\n\t    w&&w(); \r\n\t    /*if(SetHashParam){\r\n\t        SetHashParam(\"vName\", undefined);\r\n\t        SetHashParam(\"vCategory\", undefined);\r\n\t        SetHashParam(\"vTab\", undefined);\r\n\t    }*/\r\n\t});\r\n\t\r\n\t$scope.onUpload = function(){\r\n\t    let fl = $(\"<input type='file' multiple>\")\r\n\t    fl.change(function(e){\r\n\t        ProcessUploads(Array.from(e.target.files));\r\n\t        $scope.$applyAsync();\r\n\t    })\r\n\t    fl[0].click();\r\n\t}\r\n\t\r\n\t$scope.UploadAll = function(){\r\n\t    $q.all($scope.Uploads.map((u) =>{\r\n\t        return $http.post(\"/api/view/SaveCustomView2\",u).then(function(){\r\n\t            let i = $scope.Uploads.indexOf(u);\r\n\t            $scope.Uploads.splice(i,1);\r\n\t        });\r\n\t    })).then(function(){\r\n\t        if(!$scope.Uploads.length)$scope.Uploads=null;\r\n\t    });\r\n\t}\r\n\t\r\n\t$scope.remove = function(list, index){\r\n\t    list.splice(index,1);\r\n\t}\r\n\t\r\n\t$scope.ClearUploads = function(){\r\n\t    $scope.Uploads=null;\r\n\t}\r\n\t\r\n\tfunction ProcessUploads(files){\r\n        $q.all(files.map(c => c.text())).then(function(f){\r\n            $scope.Uploads = ($scope.Uploads||[]).concat(f.map((txt, i) => {\r\n                if(files[i].name.slice(-5)==\".json\"){\r\n                    try{\r\n                        return {\r\n                            Name: files[i].name.slice(0,-5),\r\n                            View: JSON.parse(txt)\r\n                        }\r\n                    } catch(e){}\r\n                }\r\n                return null;\r\n            }).filter(c => c));\r\n        });\t    \r\n\t}\r\n\t\r\n\t$scope.onDragOver = function(e){ e.preventDefault(); };\r\n\t$scope.onDragLeave = function(e){ e.preventDefault(); };\r\n\t$scope.onDragDrop = function(e){\r\n\t    e.preventDefault();\r\n\t    ProcessUploads(Array.from(e.originalEvent.dataTransfer.files));\r\n\t}\r\n\t\r\n\t$scope.Download = function(n,e){\r\n\t    e.preventDefault();\r\n\t    $http.post(\"/api/view/GetCustomView2\", { Name: n }).then(function (r) {\r\n\t        Download(\"\\ufeff\" + JSON.stringify(r.data,null,\"\\t\"), r.headers(\"content-type\"), n + \".json\");\r\n\t    });\r\n\t}\r\n\t\r\n\t$scope.GetCustomViews();/*.then(function(){\r\n        if(GetHashParams){\r\n            let p = GetHashParams();\r\n            if(p.vCategory)$scope.SelectCategory(p.vCategory);\r\n            if(p.vName)$scope.SelectCustomView(p.vName).then(function(){\r\n                if(p.vTab)$scope.ViewSelectTab(+p.vTab);\r\n            });\r\n        }\r\n\t});*/\r\n\t$scope.NewCustomViewName = \"\";\r\n\t$scope.toggleView = function(){\r\n\t    $scope.showScript =! $scope.showScript;\r\n\t}\r\n\t$scope.SelectCategory = function(c){\r\n\t    $scope.Category = c || null;\r\n\t    //if(SetHashParam)SetHashParam(\"vCategory\", $scope.Category||undefined);\r\n\t}\r\n\t$scope.CreateCustomView = function () {\r\n\t\t$scope.CurCustomView = { \r\n\t\t    Controller: '[\"$scope\", \"$http\", function ($scope, $http) { }]',\r\n\t\t    Category: $scope.Category||null,\r\n\t\t    Roles: {\"SuperAdmin\":true},\r\n\t\t    Html: `<md-card>\r\n    <md-toolbar class=\"md-table-toolbar md-default\">\r\n        <div class=\"md-toolbar-tools\">\r\n            <h2 class=\"text-center\">Title</h2>\r\n        </div>\r\n    </md-toolbar>\r\n    <md-card-content>\r\n    \r\n    </md-card-content>\r\n    <md-card-actions>\r\n    \r\n    </md-card-actions>\r\n</md-card>`\r\n\t\t};\r\n\t}\r\n\t$scope.CustomViewBack = function () {\r\n\t\tdelete $scope.CurCustomView;\r\n\t    /*if(SetHashParam){\r\n\t        SetHashParam(\"vName\", undefined);\r\n\t        SetHashParam(\"vTab\", undefined);\r\n\t    }*/\r\n\t}\r\n\t$scope.GetAllCustomViews = function(){\r\n\t    //if(!$scope.Category) return $scope.CustomViews;\r\n\t    return ($scope.CustomViews||[]).filter(c => $scope.CustomViewsObj[c]==$scope.Category);\r\n\t}\r\n\t$scope.SelectCustomView = function (v) {\r\n\t\treturn $http.post(\"/api/view/GetCustomView\", { Name: v }).then(function (r) {\r\n\t\t\t$scope.CurCustomView = r.data;\r\n\t\t\t$scope.CurCustomView.Name = v;\r\n\t\t\t$scope.CurCustomView.Parent = $scope.Parents[v];\r\n\t\t\t$scope.CurCustomView.Roles = {};\r\n\t\t\tif (r.data.Access)\r\n\t\t\t\tr.data.Access.forEach(function (c) {\r\n\t\t\t\t\tr.data.Roles[c] = 1;\r\n\t\t\t\t});\r\n\t        //if(SetHashParam)SetHashParam(\"vName\", v||undefined);\r\n\t\t});\r\n\t}\r\n\t$scope.SetCustomViewAccess = function (v) {\r\n\t\tif ($scope.CurCustomView.Roles[v])\r\n\t\t\tdelete $scope.CurCustomView.Roles[v];\r\n\t\telse\r\n\t\t\t$scope.CurCustomView.Roles[v] = 1;\r\n\t}\r\n\t$scope.Save = function () {\r\n\t\tlet nm = $scope.CurCustomView.Name;\r\n\t\t$scope.Saving = true;\r\n\t\t$http.post(\"/api/view/SaveCustomView\", {\r\n\t\t\tName: $scope.CurCustomView.Name,\r\n\t\t\tView: {\r\n\t\t\t    Category: $scope.CurCustomView.Category,\r\n\t\t\t\tController: $scope.CurCustomView.Controller,\r\n\t\t\t\tIsModal: $scope.CurCustomView.IsModal,\r\n\t\t\t\tDescr: $scope.CurCustomView.Descr,\r\n\t\t\t\tHtml: $scope.CurCustomView.Html,\r\n\t\t\t\tAccess: Object.keys($scope.CurCustomView.Roles || {})\r\n\t\t\t}\r\n\t\t}).then(function () {\r\n\t\t\t$scope.CurCustomView.Name = nm;\r\n\t\t\t$scope.GetCustomViews();\r\n\t\t\t$scope.$root.showMessage(\"Saved\");\r\n\t\t\t$scope.Saving = false;\r\n\t\t});\r\n\t\t$scope.CurCustomView.Name = \"\";\r\n\t}\r\n\t$scope.show = function(){\r\n\t    $scope.ref.Result = null;\r\n\t    let options = {\r\n\t        escapeToClose: true,\r\n\t        clickOutsideToClose: true,\r\n\t    }\r\n        modal($scope.CurCustomView.Name, options, eval(\"(\" + ($scope.ref.ModalData||null) + \")\")).then(function(r){\r\n            $scope.ref.Result = r;\r\n        }, function(r){\r\n            $scope.ref.Result = r;\r\n        });\r\n    }\r\n\t$scope.show2 = function(){\r\n\t    $scope.ref.Result = null;\r\n\t    let options = {\r\n\t        escapeToClose: true,\r\n\t        clickOutsideToClose: true,\r\n\t    }\r\n        modal2($scope.CurCustomView.Name, options, eval(\"(\" + ($scope.ref.ModalData||null) + \")\")).then(function(r){\r\n            $scope.ref.Result = r;\r\n        }, function(r){\r\n            $scope.ref.Result = r;\r\n        });\r\n    }\r\n}]","IsModal":false,"Descr":null,"Html":"<md-card ng-if=\"Uploads&&Uploads.length\" style=\"display: inline-flex;\">\r\n    <md-card-content>\r\n        <table class=\"table\">\r\n            <tr>\r\n                <th>Filename</th>\r\n                <th>Category</th>\r\n                <th>Controller</th>\r\n                <th>HTML</th>\r\n                <th>Modal</th>\r\n                <th>Access</th>\r\n                <th></th>\r\n            </tr>\r\n            <tr ng-repeat=\"u in Uploads\">\r\n                <td>{{u.Name}}.json</td>\r\n                <td>{{u.View.Category}}</td>\r\n                <td>{{!!u.View.Controller?'&check;':''}}</td>\r\n                <td>{{!!u.View.Html?'&check;':''}}</td>\r\n                <td>{{!!u.View.IsModal?'&check;':''}}</td>\r\n                <td><span ng-repeat=\"a in u.View.Access\">{{a}}{{ $last?'':', '}}</span></td>\r\n                <td>\r\n                    <md-button ng-click=\"remove(Uploads, $index)\" class=\"md-icon-button md-raised md-warn\"><i class=\"mdi mdi-close\"></i></md-button>\r\n                </td>\r\n            </tr>\r\n        </table>\r\n    </md-card-content>\r\n    <md-card-actions>\r\n        <md-button ng-click=\"ClearUploads()\">Clear</md-button>\r\n        <md-button class=\"md-raised md-primary\" ng-click=\"UploadAll()\">Upload All</md-button>\r\n    </md-card-actions>\r\n</md-card>\r\n<div layout=\"row\" layout-line=\"space-between center\">\r\n\t<div style=\"padding:5px\" flex=\"50\">\r\n        <md-card>\r\n            <md-card-content em-dragover=\"onDragOver($event)\" em-dragleave=\"onDragLeave($event)\" em-drop=\"onDragDrop($event)\">\r\n                <div style=\"position:relative\">\r\n                    <div style=\"height:calc(100vh - 290px);overflow-y:auto\">\r\n                        <div style=\"height:50px\"></div>\r\n                        <div ng-if=\"!CurCustomView\">\r\n                            <div class=\"iBlock\" style=\"position:relative\">\r\n                                <div style=\"height:calc(100vh - 360px);overflow-y:auto;\">\r\n                                    <table class=\"table\" style=\"width:100%\">\r\n                                        <tr><th>Categories</th></tr>\r\n                                        <tr ng-click=\"SelectCategory()\"><td style=\"padding:0 10px;cursor:pointer;{{!Category?'background-color:blue;color:white':''}}\">(none)</td></tr>\r\n                                        <tr ng-repeat=\"c in Categories\">\r\n                                            <td ng-click=\"SelectCategory(c)\" style=\"padding:0 10px;cursor:pointer;{{Category==c?'background-color:blue;color:white':''}}\">{{c}}</td>\r\n                                        </tr>\r\n                                    </table>\r\n                                </div>\r\n                                <div style=\"position:absolute;top:0;width:calc(100% - 15px)\">\r\n                                    <table class=\"table\" style=\"background-color:white\">\r\n                                        <tr><th>Categories</th></tr>\r\n                                    </table>\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"iBlock\" style=\"position:relative\">\r\n                                <div style=\"position:absolute;background-color:white;height:calc(100vh - 360px);overflow-y:auto\">\r\n                                \t<table class=\"table em-resizer\" style=\"width:10px\">\r\n                                        <tr><th><div>Views</div></th><th><div>Download</div></th></tr>\r\n                                \t\t<tr ng-repeat=\"v in GetAllCustomViews()\">\r\n                                \t\t\t<td ng-click=\"SelectCustomView(v)\" style=\"white-space:pre;cursor:pointer;\">{{v}}</td>\r\n                                \t\t\t<td><a class=\"btn-link\" href=\"{{v}}.json\" style=\"white-space:pre\" ng-click=\"Download(v, $event)\">{{v}}.json</a></td>\r\n                                \t\t</tr>\r\n                                \t</table>\r\n                                </div>\r\n                        \t\t    <div style=\"position:absolute;height:10px\">\r\n                                \t\t<table class=\"table\" style=\"width:10px;background-color:white;\">\r\n                                            <tr>\r\n                                                <th><div style=\"width:{{cvCols[0]||'10px'}}\">Views</div></th>\r\n                                                <th><div style=\"width:{{cvCols[1]||'10px'}}\">Download</div></th>\r\n                                            </tr>\r\n                                \t\t</table>\r\n                            \t\t</div>\r\n                            \t</div>\r\n                        \t</div>\r\n                \t\t<div ng-if=\"CurCustomView\">\r\n                            <md-tabs md-dynamic-height md-border-bottom>\r\n                                <md-tab label=\"Details\" md-on-select=\"ViewSelectTab(0)\" md-active=\"vTab==0\">\r\n                                    <md-content class=\"md-padding\" layout=\"column\">\r\n                                        <div layout=\"row\">\r\n                                            <md-input-container flex=\"90\">\r\n                                                <input type=\"text\" placeholder=\"Name\" ng-model=\"CurCustomView.Name\" />\r\n                                            </md-input-container>\r\n                                            <md-input-container flex>\r\n                                                <md-checkbox id=\"isModal\" type=\"checkbox\" class=\"md-primary\" ng-model=\"CurCustomView.IsModal\"><span  style=\"white-space:nowrap\">Is Modal</span></md-checkbox>\r\n                                            </md-input-container>\r\n                                        </div>\r\n                                        <md-input-container>\r\n                                            <input placeholder=\"Category\" type=\"text\" ng-model=\"CurCustomView.Category\" />\r\n                                        </md-input-container>\r\n                                        <md-input-container>\r\n                                            <md-select placeholder=\"Parent\" ng-model=\"CurCustomView.Parent\" ng-change=\"saveParent(CurCustomView.Name,CurCustomView.Parent)\">\r\n                                                <md-option ng-value=\"null\">(None)</md-option>\r\n                                                <md-option ng-repeat=\"p in CustomViews\" value=\"{{p}}\">{{p}}</md-option>\r\n                                            </md-select>\r\n                                        </md-input-container>\r\n                                    </md-content>\r\n                                </md-tab>\r\n                                <md-tab label=\"HTML\" md-on-select=\"ViewSelectTab(1)\" md-active=\"vTab==1\">\r\n                                    <md-content class=\"md-padding\">\r\n                                        <div class=\"editor\" style=\"min-height:calc(100vh - 422px);resize:vertical\" ui-ace=\"{ mode: 'html', theme: 'monokai' }\" ng-model=\"CurCustomView.Html\"></div>\r\n                                    </md-content>\r\n                                </md-tab>\r\n                                <md-tab label=\"Javascript\" md-on-select=\"ViewSelectTab(2)\" md-active=\"vTab==2\">\r\n                                    <md-content class=\"md-padding\">\r\n                                        <div class=\"editor\" style=\"min-height:calc(100vh - 422px);resize:vertical\" ui-ace=\"{ mode: 'javascript', theme: 'monokai' }\" ng-model=\"CurCustomView.Controller\"></div>\r\n                                    </md-content>\r\n                                </md-tab>\r\n                                <md-tab label=\"Description\" md-on-select=\"ViewSelectTab(3)\" md-active=\"vTab==3\">\r\n                                    <md-content class=\"md-padding\">\r\n                                        <text-angular ng-model=\"CurCustomView.Descr\"></text-angular>\r\n                                    </md-content>\r\n                                </md-tab>\r\n                                <md-tab label=\"Access\" md-on-select=\"ViewSelectTab(4)\" md-active=\"vTab==4\">\r\n                                    <md-content class=\"md-padding\">\r\n                                        <table>\r\n                                            <tr ng-repeat=\"r in Roles\" style=\"{{CurCustomView.Roles[r]?'color:blue':'color:grey'}}\" ng-click=\"SetCustomViewAccess(r)\"><td>{{r}}</td></tr>\r\n                                        </table>\r\n                                    </md-content>\r\n                                </md-tab>\r\n                            </md-tabs>\r\n                \t\t</div>\r\n                    </div>\r\n            \t    <div style=\"position:absolute;top:0;width:calc(100% - 20px);z-index:49\">\r\n            \t        <div style=\"background-color:white;\">\r\n                \t\t<md-button class=\"md-raised\" ng-if=\"!CurCustomView\" ng-click=\"CreateCustomView()\">New</md-button>\r\n                \t\t<md-button class=\"md-raised\" ng-if=\"!CurCustomView\" ng-click=\"onUpload()\">Upload</md-button>\r\n            \t        <md-button class=\"md-raised md-warn\" ng-if=\"CurCustomView\" ng-click=\"CustomViewBack()\">Back</md-button>\r\n                \t\t<md-button class=\"md-raised md-primary\" ng-disabled=\"!CurCustomView.Name\" ng-if=\"CurCustomView\" ng-click=\"Save()\">Save</md-button>\r\n                \t\t<md-button class=\"\" ui-sref=\"root.defaultlayout.project.views({name: CurCustomView.Name})\" ng-if=\"CurCustomView&&CurCustomView.Name\" target=\"_blank\">{{CurCustomView.Name}}</md-button>\r\n                \t\t</div>\r\n                    </div>\r\n                </div>\r\n            </md-card-content>\r\n        </md-card>\r\n    </div>\r\n\t<div flex=\"45\" style=\"padding:5px\" ng-if=\"CurCustomView.Parent || (CurCustomView.Name && !CurCustomView.IsModal)\">\r\n\t\t<div style=\"height:calc(100vh - 250px);overflow-y:auto\">\r\n\t\t    <div ng-if=\"CurCustomView.Name!='Custom Views'\" debug emc-directive=\"{{CurCustomView.Parent||CurCustomView.Name}}\"></div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div flex=\"40\" style=\"padding:5px\" ng-if=\"CurCustomView.IsModal && !CurCustomView.Parent\">\r\n\t\t<div style=\"height:calc(100vh - 250px);overflow-y:auto\">\r\n            <md-button ng-click=\"show()\">Show</md-button>\r\n            <md-button ng-click=\"show2()\">Show2</md-button>\r\n            <div>Data</div>\r\n            <div class=\"editor\" ui-ace=\"{ mode: 'javascript', theme: 'monokai' }\" ng-model=\"ref.ModalData\" style=\"font-family: monospace;white-space:pre\"></div>\r\n            <div ng-if=\"ref.Result\">\r\n                Result:\r\n                <pre>{{ref.Result|json}}</pre>\r\n            </div>\r\n        </div>\r\n\t</div>\r\n</div>\r\n\r\n","Name":"Custom Views"}